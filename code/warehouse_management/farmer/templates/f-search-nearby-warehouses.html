{% comment %} {% extends 'f-base-generic.html' %}

{% block content %}


    {% if messages %}
    <ul class="messages">
    {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
    </ul>
    {% endif %}


    <form action="{% url 'farmer:showNearbyWarehouses'%}" method="post">
    {% csrf_token %}
        <label for="latitude">Latitude:</label><br>
        <input type="text" id="latitude" name="latitude"><br><br>
        <label for="longitude">Longitude:</label><br>
        <input type="text" id="longitude" name="longitude"><br><br>
        <label for="distance">Distance:</label><br>
        <input type="text" id="distance" name="distance"><br><br>
        <input type="submit" value="Submit" class="btn btn-primary">
    </form> 
{% endblock %} {% endcomment %}

{% load static %}

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<link rel="shortcut icon" type="image/png" href="/icon.png" />

		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>

		<!-- Leaflet library -->
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
			integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
			crossorigin=""
		/>
		<script
			src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
			integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
			crossorigin=""
		></script>
		<!-- / Leaflet library -->

		<!-- Material Icons -->
		<link
			href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
		/>

		<link rel="stylesheet" href="{% static 'styles/f-nearby.css' %}" />


		<title>Find nearby Warehouse</title>
	</head>
	<body>
		<div class="container">
            <aside>
				<div class="top">
					<div class="logo">
						<img src="{% static 'Images/WarehouseWise.png' %}" />
					</div>
					<div class="close" id="close-btn">
						<span class="material-symbols-outlined"> close </span>
					</div>
				</div>
				<div class="sidebar">
					<a href="{% url 'farmer:home' %}">
						<img
							src="{% static 'Images/navbar/house.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Home</h3>
					</a>

					<a
						href="{% url 'farmer:makeReservation' %}"
					>
						<img
							src="{% static 'Images/navbar/list-plus.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Add Reservation</h3>
					</a>
					<a href="{% url 'farmer:showReservations' %}">
						<img
							src="{% static 'Images/Navbar/report-text-svgrepo-com.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Show Reservations</h3>
					</a>
					<a href="{% url 'farmer:generateReport' %}">
						<img
							src="{% static 'Images/Navbar/file-arrow-down.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Generate Report</h3>
					</a>
					<a href="{% url 'farmer:searchNearbyWarehouses' %}">
						<img
							src="{% static 'Images/Navbar/file-arrow-down.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Nearby warehouses</h3>
					</a>
					<a href="{% url 'farmer:videoCall' %}">
						<img
							src="{% static 'Images/Navbar/video-camera.svg' %}"
							alt=""
							class="navbar--menu-icon"
						/>
						<h3>Video Call</h3>
					</a>

					<a href="{% url 'farmer:logout' %}">
						<img
							class="navbar--menu-icon"
							src="{% static 'Images/navbar/logout-svgrepo-com.svg' %}"
							alt=""
						/>
						<h3>Logout</h3>
					</a>
				</div>
			</aside>

			<main>
				<div class="heading--container">
					<h1 class="heading">Nearby Warehouse's</h1>
					<div class="address--div">
						<div class="location--heading-div">
							<svg class="current--location-svg"></svg>
							<h2 class="your--location-heading">
								Your Location Detected as:
							</h2>
						</div>
						<address class="address"></address>
					</div>
				</div>

				<div class="map--container">
					<div class="map--div">
						<div id="map"></div>
					</div>
					<div class="warehouse--locations--div">
						<h4 class="area--location">
							Results for
							<strong class="area--location-text"></strong>
							:
						</h4>
						<div class="Warehouse--locations"></div>
					</div>
				</div>
			</main>
			<!-- Trigger/Open The Modal -->

			<!-- The Modal -->
		</div>
		<div id="myModal" class="modal">
			<!-- Modal content -->
			<div class="modal-content">
				<form action="{% url 'farmer:showNearbyWarehouses'%}" method="post">
                    {% csrf_token %}
					<div class="user-details">
						<div class="input-box">
							<label class="details">Latitude</label>
							<input
								type="number"
								name="latitude"
								id="latitude"
								required
							/>
						</div>
						<div class="input-box">
							<label class="details">Longitude</label>
							<input
								type="number"
								name="longitude"
								id="longitude"
								required
							/>
						</div>
						<div class="input-box">
							<label class="details">Distance ( in Kms) </label>
							<input
								type="number"
								name="distance"
								id="Distance"
								placeholder="Enter your desiered distance"
								required
								min="1"
							/>
						</div>
						<div class="input-box Detect-location">
							<button class="button-8">
								<span
									><svg
										xmlns="http://www.w3.org/2000/svg"
										height="18"
										viewBox="0 96 960 960"
										width="18"
										fill="#c12424"
									>
										<path
											d="M450 1014v-75q-137-14-228-105T117 606H42v-60h75q14-137 105-228t228-105v-75h60v75q137 14 228 105t105 228h75v60h-75q-14 137-105 228T510 939v75h-60Zm30-134q125 0 214.5-89.5T784 576q0-125-89.5-214.5T480 272q-125 0-214.5 89.5T176 576q0 125 89.5 214.5T480 880Zm0-154q-63 0-106.5-43.5T330 576q0-63 43.5-106.5T480 426q63 0 106.5 43.5T630 576q0 63-43.5 106.5T480 726Zm0-60q38 0 64-26t26-64q0-38-26-64t-64-26q-38 0-64 26t-26 64q0 38 26 64t64 26Zm0-90Z"
										/></svg></span
								>Detect Location
							</button>
						</div>
					</div>
					<div class="button">
						<input
							type="submit"
							class="submit--btn"
							value="Submit"
						/>
					</div>
				</form>
			</div>
		</div>

        <script>
                        
            const clearbtn = document.querySelector(".clear-btn");
            const containerEl = document.querySelector(".container");
            const addressEL = document.querySelector(".address");
            const warehouselocationsEl = document.querySelector(".Warehouse--locations");
            const areaLocationText = document.querySelector(".area--location-text");

            async function getCurrentAdress() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;

                        const response = await fetch(
                            `https://www.mapquestapi.com/geocoding/v1/reverse?key=7NUljeotQj6pdb8DXIKuyN62EXTbmAHi&location=${latitude},${longitude}&includeRoadMetadata=true&includeNearestIntersection=true`
                        );
                        const jsonData = await response.json();
                        const location = jsonData.results[0].locations[0];
                        const addressText = `${location.adminArea6}, ${location.adminArea5}, ${location.adminArea3} ${location.adminArea1}`;

                        addressEL.innerHTML = addressText;
                        areaLocationText.innerHTML = `${location.adminArea6}, ${location.adminArea5}`;
                    });
                }
            }

            getCurrentAdress();

            let HomeIcon = L.icon({
                iconUrl: "Images/homeIcon.png",
                iconSize: [50, 50], // size of the icon
                iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                shadowAnchor: [4, 62], // the same for the shadow
                popupAnchor: [-3, -76], // point from which the popup should open relative to the iconAnchor
            });

            let map = L.map("map").setView([23.1870706, 72.6268105], 15);

            L.marker([23.1870706, 72.6268105], { icon: HomeIcon }).addTo(map);

            L.tileLayer("https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png", {
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> <a target="_blank" href="https://icons8.com/icon/65839/home-address">Home Address</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a> contributors',
            }).addTo(map);

            let locations = [
                {
                    id: 1,
                    lat: 23.185675,
                    long: 72.629526,
                    title: "5-Star Thing Storage",
                    src: "https://images.unsplash.com/photo-1586528116311-ad8dd3c8310d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=870&q=80",
                    url: "https://www.google.co.in/ ",

                    rating: 3,
                },
                {
                    id: 2,
                    lat: 23.196996,
                    long: 72.631386,
                    title: "hamofy",
                    src: "https://images.unsplash.com/photo-1627309366653-2dedc084cdf1?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1966&q=80",
                    url: "https://www.google.co.in/ ",

                    rating: 5,
                },
                {
                    id: 3,
                    lat: 23.185158,
                    long: 72.62724,
                    title: "Anetly",
                    src: "https://images.unsplash.com/photo-1557761469-f29c6e201784?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=849&q=80",
                    url: "https://www.google.co.in/ ",

                    rating: 4,
                },
                {
                    id: 4,
                    lat: 23.184634,
                    long: 72.628892,
                    title: "Upright Storage Locker Co",
                    src: "https://images.unsplash.com/photo-1599452390941-251da594d7e3?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=870&q=80",
                    url: "https://www.google.co.in/ ",
                    rating: 3,
                },
            ];

            let popupOption = {
                closeButton: false,
            };

            locations.forEach((location) => {
                new L.marker([location.lat, location.long], {
                    icon: new L.DivIcon({
                        className: "my-div-icon",
                        html: `<button class="pin--location"><p>${location.title}</p></button>`,
                    }),
                })
                    .addTo(map)
                    .on("click", function () {
                        let marker = this;
                        // const popupEl = document.querySelectorAll('.popup');

                        // popupEl.forEach(Element => {
                        //   Element.classList.add('hidden');
                        // });

                        // if (event.target._popup) {
                        //   console.log(event.target._popup);
                        //   console.log(
                        //     (event.target._popup._contentNode.parentNode.parentNode.style.opacity = 1)
                        //   );
                        // }

                        marker.bindPopup(
                            `      <div class="card">
                    <div class="card_image">
                    <img src=${location.src} alt="mixed vegetable salad in a mason jar." />
                    </div>
                    <div class="card_content">
                    <h2 class="card_title">${location.title}</h2>
                    <div class="card_text">
                    </div>
                    </div>
                </div>
                    `,
                            {
                                maxWidth: 300,
                                minWidth: 250,
                                maxHeight: 160,
                                autoPan: true,
                                closeButton: true,
                                autoPanPadding: [5, 5],
                            }
                        );

                        marker.openPopup();
                    });
            });



            {% comment %} addWarehouseLocations(locations); {% endcomment %}

            // const options = {
            //   method: 'GET',
            //   headers: {
            //     'X-RapidAPI-Key': '8048530456mshd702a7e93d8d947p133668jsn0dcdbe319bbd',
            //     'X-RapidAPI-Host': 'trueway-matrix.p.rapidapi.com',
            //   },
            // };

            // fetch(
            //   'https://trueway-matrix.p.rapidapi.com/CalculateDrivingMatrix?origins=23.1870706%2C%2072.6268105&destinations=23.185675%2C72.629526',
            //   options
            // )
            //   .then(response => response.json())
            //   .then(response => console.log(response))
            //   .catch(err => console.error(err));

            //  Modal window

            // Get the modal
            const modal = document.getElementById("myModal");

            // Get the button that opens the modal
            const btn = document.getElementById("myBtn");

            // Get the <span> element that closes the modal
            const submitBtnEl = document.querySelector(".submit--btn");
            // When the user clicks on the button, open the modal

            const latitudeEl = document.getElementById("latitude");
            const longitudeEl = document.getElementById("longitude");
            const distanceEl = document.getElementById("Distance");

            const detectButton = document.querySelector(".button-8");

            detectButton.addEventListener("click", function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const { latitude, longitude } = position.coords;
                        latitudeEl.setAttribute("value", `${latitude}`);
                        longitudeEl.setAttribute("value", `${longitude}`);
                    });
                }
            });

            // When the user clicks on <span> (x), close the modal

            const DetectLocation = () => {
                modal.style.display = "block";
            };

            submitBtnEl.addEventListener("click", function (e) {
                if (distanceEl.value != "") {
                    modal.style.display = "none";
                }
            });

            setTimeout(DetectLocation, 500);

            // When the user clicks anywhere outside of the modal, close it

        </script>
	</body>
</html>
